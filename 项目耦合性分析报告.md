# é¡¹ç›®è€¦åˆæ€§åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**ï¼š2024å¹´12æœˆ  
**é¡¹ç›®åç§°**ï¼šAIAssit  
**åˆ†æèŒƒå›´**ï¼šæ•´ä¸ªé¡¹ç›®æ¶æ„

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

### è€¦åˆåº¦æ€»ä½“è¯„ä»·ï¼šğŸŸ¡ **ä¸­ç­‰åé«˜**

é¡¹ç›®æ•´ä½“æ¶æ„ç›¸å¯¹æ¸…æ™°ï¼Œé‡‡ç”¨äº†åˆ†å±‚è®¾è®¡ï¼Œä½†å­˜åœ¨ä»¥ä¸‹ä¸»è¦é—®é¢˜ï¼š
- âŒ **åå‘ä¾èµ–**ï¼š`MessageManager` ä¾èµ– `ChatInputWidget`ï¼ˆåº”åå‘ï¼‰
- âŒ **å°è£…ä¸è¶³**ï¼š`MessageManager` å¤§é‡æˆå‘˜æš´éœ²ä¸º public
- âŒ **ç›´æ¥è®¿é—®ç§æœ‰æˆå‘˜**ï¼š`Frm_AIAssit` ç›´æ¥è®¿é—® `m_NetWorkParams`
- âš ï¸ **ç¼–è¯‘æ—¶ä¾èµ–è¿‡å¤š**ï¼š`LLMFunctionCall` åŒ…å«æ‰€æœ‰å·¥å…·æ¨¡å—å¤´æ–‡ä»¶
- âš ï¸ **ä¸»çª—å£èŒè´£è¿‡é‡**ï¼š`Frm_AIAssit` ä¾èµ– 12+ ä¸ªæ¨¡å—

---

## ğŸ—ï¸ æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           UI å±‚ï¼ˆPresentationï¼‰          â”‚
â”‚  Frm_AIAssitï¼ˆä¸»çª—å£ï¼‰                   â”‚
â”‚  â”œâ”€â”€ ChatInputWidgetï¼ˆè¾“å…¥ç»„ä»¶ï¼‰         â”‚
â”‚  â”œâ”€â”€ ChatShowWidgetï¼ˆæ˜¾ç¤ºç»„ä»¶ï¼‰          â”‚
â”‚  â”œâ”€â”€ ChatListï¼ˆå¯¹è¯åˆ—è¡¨ï¼‰                â”‚
â”‚  â”œâ”€â”€ LLMChatFrameï¼ˆèŠå¤©æ°”æ³¡ï¼‰            â”‚
â”‚  â””â”€â”€ AIParamWidgetï¼ˆå‚æ•°è®¾ç½®ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æœåŠ¡å±‚ï¼ˆService Layerï¼‰            â”‚
â”‚  â”œâ”€â”€ ChatSessionServiceï¼ˆä¼šè¯ç®¡ç†ï¼‰      â”‚
â”‚  â”œâ”€â”€ LLMClientManagerï¼ˆå®¢æˆ·ç«¯ç®¡ç†ï¼‰      â”‚
â”‚  â””â”€â”€ AppConfigRepositoryï¼ˆé…ç½®å­˜å‚¨ï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆBusiness Logicï¼‰         â”‚
â”‚  â”œâ”€â”€ MessageManagerï¼ˆæ¶ˆæ¯ç®¡ç†å™¨åŸºç±»ï¼‰    â”‚
â”‚  â”‚   â”œâ”€â”€ Open_WebUIClient              â”‚
â”‚  â”‚   â”œâ”€â”€ OllamaClient                  â”‚
â”‚  â”‚   â””â”€â”€ DifyClient                    â”‚
â”‚  â”œâ”€â”€ LLMFunctionCallï¼ˆå‡½æ•°è°ƒç”¨ç®¡ç†ï¼‰     â”‚
â”‚  â”œâ”€â”€ FunctionCallRouterï¼ˆå·¥å…·è·¯ç”±ï¼‰      â”‚
â”‚  â””â”€â”€ LLMParamsï¼ˆå‚æ•°ç®¡ç†ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å·¥å…·å±‚ï¼ˆTools Layerï¼‰              â”‚
â”‚  â”œâ”€â”€ FileSystemTools                    â”‚
â”‚  â”œâ”€â”€ TextProcessingTools                â”‚
â”‚  â”œâ”€â”€ ClipboardTools                     â”‚
â”‚  â”œâ”€â”€ SystemInfoTools                    â”‚
â”‚  â”œâ”€â”€ DateTimeTools                      â”‚
â”‚  â”œâ”€â”€ UtilityTools                       â”‚
â”‚  â”œâ”€â”€ DataFormatTools                    â”‚
â”‚  â”œâ”€â”€ VisionTools                        â”‚
â”‚  â””â”€â”€ GitTools                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” è¯¦ç»†è€¦åˆåˆ†æ

### 1. UI å±‚è€¦åˆåˆ†æ

#### 1.1 Frm_AIAssitï¼ˆä¸»çª—å£ï¼‰ğŸ”´ **é«˜è€¦åˆ**

**ä¾èµ–æ•°é‡**ï¼š12+ ä¸ªæ¨¡å—

**ç›´æ¥ä¾èµ–**ï¼š
```cpp
#include "LLMParams.h"
#include "LLMChatFrame.h"
#include "ChatInputWidget.h"
#include "LLMFunctionCall.h"
#include "GitLogReader.h"
#include "MessageManager.h"
#include "ChatSessionService.h"
#include "ChatSessionTypes.h"
#include "AppConfigRepository.h"
#include "LLMClientManager.h"
#include "AIParamWidget.h"
#include "ui_Frm_AIAssit.h"
```

**è€¦åˆé—®é¢˜**ï¼š
- âŒ **è¿åå•ä¸€èŒè´£åŸåˆ™**ï¼šä¸»çª—å£æ‰¿æ‹…äº†å¤ªå¤šèŒè´£
  - UI æ¸²æŸ“å’Œå¸ƒå±€
  - ä¸šåŠ¡é€»è¾‘åè°ƒ
  - çŠ¶æ€ç®¡ç†
  - å·¥å…·è°ƒç”¨å¤„ç†
  - ä¼šè¯ç®¡ç†
  - ç½‘ç»œè¯·æ±‚å‘é€

- âŒ **ç›´æ¥è®¿é—®ç§æœ‰æˆå‘˜**ï¼š
```cpp
// Frm_AIAssit.cpp:762-763
LLMClient->m_NetWorkParams->clientRequest.setSslConfiguration(config);
QNetworkReply *reply = LLMClient->m_NetWorkParams->clientNetWorkManager->post(...);
```
  è¿™è¿åäº†å°è£…åŸåˆ™ï¼Œç›´æ¥è®¿é—®äº† `MessageManager` çš„ç§æœ‰æˆå‘˜ã€‚

- âš ï¸ **ä¸šåŠ¡é€»è¾‘æ··æ‚**ï¼šåŒ…å«äº† `ProcessFunctionCall`ã€`preFuncall` ç­‰ä¸šåŠ¡é€»è¾‘æ–¹æ³•

**è¯„çº§**ï¼šğŸ”´ **C çº§**ï¼ˆè€¦åˆåº¦é«˜ï¼Œéœ€è¦é‡æ„ï¼‰

---

#### 1.2 ChatInputWidgetï¼ˆè¾“å…¥ç»„ä»¶ï¼‰

**ä¾èµ–æƒ…å†µ**ï¼š
```cpp
#include "PromptLibrary.h"
#include "PromptLibraryDialog.h"
```

**è€¦åˆé—®é¢˜**ï¼š
- âœ… **ç›¸å¯¹ç‹¬ç«‹**ï¼šä¾èµ–è¾ƒå°‘ï¼ŒèŒè´£æ¸…æ™°

**è¯„çº§**ï¼šğŸŸ¢ **A çº§**ï¼ˆè€¦åˆåº¦ä½ï¼‰

---

#### 1.3 ChatShowWidgetï¼ˆæ˜¾ç¤ºç»„ä»¶ï¼‰

**ä¾èµ–æƒ…å†µ**ï¼šä¸»è¦ä¾èµ– Qt æ ‡å‡†åº“å’Œå†…éƒ¨ç»„ä»¶

**è€¦åˆé—®é¢˜**ï¼š
- âœ… **ä¾èµ–æ¸…æ™°**ï¼šä¸»è¦ä¾èµ– UI ç»„ä»¶

**è¯„çº§**ï¼šğŸŸ¢ **A çº§**ï¼ˆè€¦åˆåº¦ä½ï¼‰

---

### 2. ä¸šåŠ¡é€»è¾‘å±‚è€¦åˆåˆ†æ

#### 2.1 MessageManagerï¼ˆæ¶ˆæ¯ç®¡ç†å™¨ï¼‰âš ï¸ **å°è£…ä¸è¶³**

**å…¬å…±æˆå‘˜æš´éœ²**ï¼š
```cpp
ClientNetWork *m_NetWorkParams;        // public âš ï¸ åº”è¯¥å°è£…
LLMParams *m_LLMParams;                // public âš ï¸ åº”è¯¥å°è£…
QTimer *m_connectionCheckTimer = nullptr;
QTimer* m_fetchModelsTimer = nullptr;
RequestType m_currentRequestType;
QStringList m_availableModelIds;       // public âš ï¸ åº”è¯¥å°è£…
std::vector<KnowledgeBase> KnowledgeInfo;
QMap<QString, QString>m_UpFiles;
```

**è€¦åˆé—®é¢˜**ï¼š
- âŒ **åå‘ä¾èµ–**ï¼š
```cpp
// MessageManager.h:9
#include "ChatInputWidget.h"

// MessageManager.h:64, 135
virtual QByteArray buildMessageBody(const ChatSendMessage& msg) = 0;
void ChangeButtonStatus(ChatInputWidget::SendButtonState state);
```
  `MessageManager`ï¼ˆä¸šåŠ¡å±‚ï¼‰ä¾èµ– `ChatInputWidget`ï¼ˆUIå±‚ï¼‰ï¼Œè¿åäº†ä¾èµ–å€’ç½®åŸåˆ™ã€‚

- âŒ **å°è£…ä¸è¶³**ï¼šå¤§é‡å†…éƒ¨çŠ¶æ€æš´éœ²ä¸º publicï¼Œå…è®¸å¤–éƒ¨ç›´æ¥è®¿é—®

- âš ï¸ **ä¿¡å·ç±»å‹ä¾èµ– UI å±‚**ï¼š`ChangeButtonStatus(ChatInputWidget::SendButtonState state)` ä½¿ä¸šåŠ¡å±‚ä¾èµ– UI å±‚ç±»å‹

**è¯„çº§**ï¼šğŸŸ¡ **B çº§**ï¼ˆè€¦åˆåº¦ä¸­ç­‰ï¼Œéœ€è¦æ”¹è¿›å°è£…ï¼‰

---

#### 2.2 LLMFunctionCallï¼ˆå‡½æ•°è°ƒç”¨ç®¡ç†å™¨ï¼‰âš ï¸ **ç¼–è¯‘æ—¶ä¾èµ–è¿‡å¤š**

**ä¾èµ–æ•°é‡**ï¼š10+ ä¸ªå·¥å…·æ¨¡å—

**ç›´æ¥ä¾èµ–**ï¼š
```cpp
#include "GitLogReader.h"
#include "FileSystemTools.h"
#include "TextProcessingTools.h"
#include "ClipboardTools.h"
#include "SystemInfoTools.h"
#include "DateTimeTools.h"
#include "UtilityTools.h"
#include "DataFormatTools.h"
#include "VisionTools.h"
#include "GitTools.h"
#include "FunctionCallRouter.h"
```

**è€¦åˆé—®é¢˜**ï¼š
- âš ï¸ **ç¼–è¯‘æ—¶ä¾èµ–è¿‡å¤š**ï¼šåŒ…å«æ‰€æœ‰å·¥å…·æ¨¡å—çš„å¤´æ–‡ä»¶
  - ä»»ä½•å·¥å…·æ¨¡å—ä¿®æ”¹éƒ½ä¼šå¯¼è‡´ `LLMFunctionCall` é‡æ–°ç¼–è¯‘
  - å¢åŠ ç¼–è¯‘æ—¶é—´å’Œç»´æŠ¤æˆæœ¬

- âš ï¸ **è¿åä¾èµ–å€’ç½®åŸåˆ™**ï¼šç›´æ¥ä¾èµ–å…·ä½“å®ç°ï¼Œè€Œä¸æ˜¯æ¥å£

**æ”¹è¿›å»ºè®®**ï¼š
- ä½¿ç”¨å‰å‘å£°æ˜ + æŒ‡é’ˆ
- è€ƒè™‘è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å·¥å…·
- ä½¿ç”¨æ¥å£æŠ½è±¡

**è¯„çº§**ï¼šğŸŸ¡ **B çº§**ï¼ˆè€¦åˆåº¦ä¸­ç­‰ï¼Œç¼–è¯‘ä¾èµ–è¿‡å¤šï¼‰

---

#### 2.3 FunctionCallRouterï¼ˆå·¥å…·è·¯ç”±å™¨ï¼‰

**ä¾èµ–æƒ…å†µ**ï¼šç›¸å¯¹ç‹¬ç«‹ï¼Œåªä¾èµ– Qt æ ¸å¿ƒåº“

**è€¦åˆé—®é¢˜**ï¼š
- âœ… **ä¾èµ–æ¸…æ™°**ï¼šèŒè´£å•ä¸€ï¼Œä¾èµ–è¾ƒå°‘

**è¯„çº§**ï¼šğŸŸ¢ **A çº§**ï¼ˆè€¦åˆåº¦ä½ï¼‰

---

### 3. å·¥å…·å±‚è€¦åˆåˆ†æ

#### 3.1 å·¥å…·æ¨¡å—ï¼ˆFileSystemToolsã€TextProcessingTools ç­‰ï¼‰

**ä¾èµ–æƒ…å†µ**ï¼šå„å·¥å…·æ¨¡å—ç›¸å¯¹ç‹¬ç«‹ï¼Œåªä¾èµ– Qt æ ¸å¿ƒåº“

**è€¦åˆé—®é¢˜**ï¼š
- âœ… **ä¾èµ–æ¸…æ™°**ï¼šå·¥å…·æ¨¡å—ä¹‹é—´æ— ç›¸äº’ä¾èµ–
- âœ… **èŒè´£å•ä¸€**ï¼šæ¯ä¸ªå·¥å…·æ¨¡å—èŒè´£æ˜ç¡®

**è¯„çº§**ï¼šğŸŸ¢ **A çº§**ï¼ˆè€¦åˆåº¦ä½ï¼‰

---

## ğŸ“ˆ è€¦åˆåº¦è¯„ä¼°çŸ©é˜µ

| ç»„ä»¶ | ä¾èµ–æ•°é‡ | è€¦åˆç±»å‹ | è€¦åˆåº¦ | è¯„çº§ | ä¸»è¦é—®é¢˜ |
|------|---------|---------|--------|------|---------|
| **Frm_AIAssit** | 12+ | ç¼–è¯‘æ—¶ | ğŸ”´ é«˜ | **C** | èŒè´£è¿‡å¤šã€ç›´æ¥è®¿é—®ç§æœ‰æˆå‘˜ |
| **MessageManager** | 2 | åå‘ä¾èµ– | ğŸŸ¡ ä¸­ | **B** | ä¾èµ– UI å±‚ã€å°è£…ä¸è¶³ |
| **LLMFunctionCall** | 10+ | ç¼–è¯‘æ—¶ | ğŸŸ¡ ä¸­ | **B** | åŒ…å«æ‰€æœ‰å·¥å…·æ¨¡å—å¤´æ–‡ä»¶ |
| **ChatInputWidget** | 2 | ç¼–è¯‘æ—¶ | ğŸŸ¢ ä½ | **A** | ä¾èµ–æ¸…æ™° |
| **FunctionCallRouter** | 0 | - | ğŸŸ¢ ä½ | **A** | ç‹¬ç«‹ï¼Œè€¦åˆåº¦æä½ |
| **å·¥å…·æ¨¡å—** | 0-1 | - | ğŸŸ¢ ä½ | **A** | ç‹¬ç«‹ï¼Œè€¦åˆåº¦ä½ |

---

## âŒ å…³é”®é—®é¢˜è¯†åˆ«

### é—®é¢˜ 1ï¼šåå‘ä¾èµ–ï¼ˆReverse Dependencyï¼‰ğŸ”´ **ä¸¥é‡**

**ä½ç½®**ï¼š`MessageManager.h`

**é—®é¢˜æè¿°**ï¼š
```cpp
// MessageManager.h:9
#include "ChatInputWidget.h"  // âŒ ä¸šåŠ¡å±‚ä¾èµ– UI å±‚

// MessageManager.h:64
virtual QByteArray buildMessageBody(const ChatSendMessage& msg) = 0;  // ChatSendMessage å®šä¹‰åœ¨ ChatInputWidget.h

// MessageManager.h:135
void ChangeButtonStatus(ChatInputWidget::SendButtonState state);  // ä¾èµ– UI å±‚ç±»å‹
```

**å½±å“**ï¼š
- è¿åä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰
- ä¸šåŠ¡å±‚æ— æ³•ç‹¬ç«‹äº UI å±‚è¿›è¡Œæµ‹è¯•
- å¢åŠ æ¨¡å—é—´çš„è€¦åˆåº¦

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
1. åˆ›å»º `CommonTypes.h`ï¼Œå°†å…±äº«ç±»å‹ï¼ˆå¦‚ `ChatSendMessage`ã€`SendButtonState`ï¼‰ç§»å‡º UI å±‚
2. `MessageManager` åªä¾èµ– `CommonTypes.h`ï¼Œä¸ä¾èµ– `ChatInputWidget.h`
3. ä½¿ç”¨æ¥å£æˆ–æŠ½è±¡åŸºç±»æ›¿ä»£ç›´æ¥ä¾èµ–

---

### é—®é¢˜ 2ï¼šç›´æ¥è®¿é—®ç§æœ‰æˆå‘˜ğŸ”´ **ä¸¥é‡**

**ä½ç½®**ï¼š`Frm_AIAssit.cpp:762-763`

**é—®é¢˜ä»£ç **ï¼š
```cpp
// Frm_AIAssit.cpp
LLMClient->m_NetWorkParams->clientRequest.setSslConfiguration(config);
QNetworkReply *reply = LLMClient->m_NetWorkParams->clientNetWorkManager->post(...);
```

**é—®é¢˜æè¿°**ï¼š
- `m_NetWorkParams` æ˜¯ `MessageManager` çš„ public æˆå‘˜ï¼ˆä½†åº”è¯¥æ˜¯ privateï¼‰
- ä¸»çª—å£ç›´æ¥è®¿é—®å†…éƒ¨ç½‘ç»œå‚æ•°ï¼Œç ´åäº†å°è£…

**å½±å“**ï¼š
- è¿åå°è£…åŸåˆ™
- å¢åŠ ä»£ç ç»´æŠ¤éš¾åº¦
- æ— æ³•åœ¨ä¸å½±å“ UI å±‚çš„æƒ…å†µä¸‹ä¿®æ”¹ç½‘ç»œå®ç°

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
1. å°† `m_NetWorkParams` æ”¹ä¸º private
2. åœ¨ `MessageManager` ä¸­æ·»åŠ å…¬å…±æ–¹æ³•ï¼š
   ```cpp
   void configureRequestSsl(const QSslConfiguration& config);
   QNetworkReply* postRequest(const QByteArray& data);
   ```

---

### é—®é¢˜ 3ï¼šMessageManager å°è£…ä¸è¶³âš ï¸ **ä¸­ç­‰**

**ä½ç½®**ï¼š`MessageManager.h:104-111`

**é—®é¢˜æè¿°**ï¼š
```cpp
ClientNetWork *m_NetWorkParams;        // public
LLMParams *m_LLMParams;                // public
QStringList m_availableModelIds;       // public
// ... å…¶ä»– public æˆå‘˜
```

**å½±å“**ï¼š
- å†…éƒ¨çŠ¶æ€å®Œå…¨æš´éœ²
- å¤–éƒ¨å¯ä»¥éšæ„ä¿®æ”¹ï¼Œéš¾ä»¥ç»´æŠ¤ä¸€è‡´æ€§
- æ— æ³•è¿›è¡Œè®¿é—®æ§åˆ¶

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
1. å°†æ‰€æœ‰ `m_*` æˆå‘˜æ”¹ä¸º private æˆ– protected
2. ä¸ºéœ€è¦å¤–éƒ¨è®¿é—®çš„æˆå‘˜æ·»åŠ è®¿é—®å™¨æ–¹æ³•
3. ä½¿ç”¨ getter/setter æ¨¡å¼

---

### é—®é¢˜ 4ï¼šLLMFunctionCall ç¼–è¯‘æ—¶ä¾èµ–è¿‡å¤šâš ï¸ **ä¸­ç­‰**

**ä½ç½®**ï¼š`LLMFunctionCall.h:13-24`

**é—®é¢˜æè¿°**ï¼š
```cpp
#include "GitLogReader.h"
#include "FileSystemTools.h"
#include "TextProcessingTools.h"
// ... 10+ ä¸ªå·¥å…·æ¨¡å—çš„å¤´æ–‡ä»¶
```

**å½±å“**ï¼š
- ç¼–è¯‘æ—¶é—´é•¿
- å·¥å…·æ¨¡å—å˜æ›´ä¼šå¯¼è‡´é‡æ–°ç¼–è¯‘
- éš¾ä»¥åŠ¨æ€æ‰©å±•å·¥å…·

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨å‰å‘å£°æ˜ + æŒ‡é’ˆ/å¼•ç”¨
2. å®ç°æ’ä»¶æœºåˆ¶ï¼ŒåŠ¨æ€åŠ è½½å·¥å…·
3. ä½¿ç”¨å·¥å‚æ¨¡å¼æ³¨å†Œå·¥å…·

---

### é—®é¢˜ 5ï¼šFrm_AIAssit èŒè´£è¿‡é‡âš ï¸ **ä¸­ç­‰**

**é—®é¢˜æè¿°**ï¼š
- ä¸»çª—å£åŒ…å«äº†å¤ªå¤šèŒè´£å’Œæ–¹æ³•ï¼ˆ200+ è¡Œä»£ç ï¼‰
- æ··åˆäº† UI é€»è¾‘ã€ä¸šåŠ¡é€»è¾‘ã€çŠ¶æ€ç®¡ç†

**å½±å“**ï¼š
- éš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•
- è¿åå•ä¸€èŒè´£åŸåˆ™
- ä»£ç å¯è¯»æ€§å·®

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
1. å¼•å…¥ Presenter/Controller å±‚
2. å°†ä¸šåŠ¡é€»è¾‘ä» UI ä¸­åˆ†ç¦»
3. ä½¿ç”¨ MVVM æˆ– MVP æ¨¡å¼

---

## ğŸ”§ æ”¹è¿›å»ºè®®

### é«˜ä¼˜å…ˆçº§æ”¹è¿›ï¼ˆç«‹å³å¤„ç†ï¼‰

#### 1. åˆ›å»º CommonTypes.h è§£å†³åå‘ä¾èµ–

**ç›®æ ‡**ï¼šå°†å…±äº«ç±»å‹ä» UI å±‚ç§»å‡º

**æ­¥éª¤**ï¼š
1. åˆ›å»º `CommonTypes.h` æ–‡ä»¶
2. å°† `ChatSendMessage` ä» `ChatInputWidget.h` ç§»å‡º
3. å°† `SendButtonState` ä» `ChatInputWidget.h` ç§»å‡º
4. `MessageManager.h` åŒ…å« `CommonTypes.h` è€Œä¸æ˜¯ `ChatInputWidget.h`

**æ–‡ä»¶ç»“æ„**ï¼š
```cpp
// CommonTypes.h
#pragma once
#include <QString>
#include <QStringList>

enum class SendButtonState { Disabled, Ready, Cancelable };

struct ChatSendMessage {
    QString SendText = "";
    QStringList Image64;
    QStringList fileContext;
};
```

---

#### 2. å°è£… MessageManager çš„ç§æœ‰æˆå‘˜

**ç›®æ ‡**ï¼šé˜²æ­¢å¤–éƒ¨ç›´æ¥è®¿é—®å†…éƒ¨çŠ¶æ€

**æ­¥éª¤**ï¼š
1. å°† `m_NetWorkParams`ã€`m_LLMParams`ã€`m_availableModelIds` æ”¹ä¸º private
2. æ·»åŠ è®¿é—®å™¨æ–¹æ³•ï¼š
   ```cpp
   LLMParams* llmParams() const { return m_LLMParams; }
   QStringList availableModels() const { return m_availableModelIds; }
   ```
3. æ·»åŠ ç½‘ç»œæ“ä½œæ–¹æ³•ï¼š
   ```cpp
   void configureRequestSsl(const QSslConfiguration& config);
   QNetworkReply* postRequest(const QByteArray& data);
   ```

---

#### 3. ä¿®å¤ Frm_AIAssit ç›´æ¥è®¿é—®ç§æœ‰æˆå‘˜

**ç›®æ ‡**ï¼šä½¿ç”¨å°è£…çš„æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥è®¿é—®

**ä¿®æ”¹**ï¼š
```cpp
// ä¿®æ”¹å‰
LLMClient->m_NetWorkParams->clientRequest.setSslConfiguration(config);
QNetworkReply *reply = LLMClient->m_NetWorkParams->clientNetWorkManager->post(...);

// ä¿®æ”¹å
LLMClient->configureRequestSsl(config);
QNetworkReply *reply = LLMClient->postRequest(data);
```

---

### ä¸­ä¼˜å…ˆçº§æ”¹è¿›ï¼ˆè¿‘æœŸè§„åˆ’ï¼‰

#### 4. å‡å°‘ LLMFunctionCall çš„ç¼–è¯‘æ—¶ä¾èµ–

**æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨å‰å‘å£°æ˜
- å»¶è¿ŸåŠ è½½å·¥å…·æ¨¡å—
- å®ç°æ’ä»¶æœºåˆ¶

#### 5. å¼•å…¥ Presenter å±‚

**æ–¹æ¡ˆ**ï¼š
- åˆ›å»º `MainWindowPresenter` ç±»
- å°†ä¸šåŠ¡é€»è¾‘ä» `Frm_AIAssit` ä¸­åˆ†ç¦»
- æé«˜å¯æµ‹è¯•æ€§

---

### ä½ä¼˜å…ˆçº§æ”¹è¿›ï¼ˆé•¿æœŸè§„åˆ’ï¼‰

#### 6. å·¥å…·æ¨¡å—æ’ä»¶åŒ–

**æ–¹æ¡ˆ**ï¼š
- å®ç°åŠ¨æ€åŠ è½½æœºåˆ¶
- æ”¯æŒè¿è¡Œæ—¶æ³¨å†Œå·¥å…·
- æé«˜æ‰©å±•æ€§

---

## ğŸ“‹ æ”¹è¿›ä¼˜å…ˆçº§çŸ©é˜µ

| æ”¹è¿›é¡¹ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ | å½±å“èŒƒå›´ | å»ºè®®æ—¶æœº |
|--------|--------|--------|----------|----------|
| åˆ›å»º CommonTypes.h | ğŸ”´ é«˜ | å° | ä¸­ç­‰ | ç«‹å³ |
| å°è£… MessageManager æˆå‘˜ | ğŸ”´ é«˜ | å° | ä¸­ç­‰ | ç«‹å³ |
| ä¿®å¤ç›´æ¥è®¿é—®ç§æœ‰æˆå‘˜ | ğŸ”´ é«˜ | å° | å° | ç«‹å³ |
| å‡å°‘ LLMFunctionCall ä¾èµ– | ğŸŸ¡ ä¸­ | ä¸­ | ä¸­ç­‰ | è¿‘æœŸ |
| å¼•å…¥ Presenter å±‚ | ğŸŸ¡ ä¸­ | å¤§ | å¤§ | ä¸­æœŸè§„åˆ’ |
| å·¥å…·æ¨¡å—æ’ä»¶åŒ– | ğŸŸ¢ ä½ | å¤§ | å¤§ | é•¿æœŸè§„åˆ’ |

---

## ğŸ“Š ä¾èµ–å…³ç³»å›¾

### å½“å‰ä¾èµ–å…³ç³»ï¼ˆç®€åŒ–ï¼‰

```
Frm_AIAssit
â”œâ”€â”€ ChatInputWidget
â”‚   â”œâ”€â”€ PromptLibrary
â”‚   â””â”€â”€ PromptLibraryDialog
â”œâ”€â”€ ChatShowWidget
â”œâ”€â”€ ChatList
â”œâ”€â”€ LLMChatFrame
â”œâ”€â”€ MessageManager âš ï¸ï¼ˆåŒ…å«åå‘ä¾èµ–ï¼‰
â”‚   â”œâ”€â”€ ChatInputWidget âŒï¼ˆåå‘ä¾èµ–ï¼‰
â”‚   â”œâ”€â”€ LLMParams
â”‚   â””â”€â”€ å­ç±»ï¼šOpen_WebUIClient, OllamaClient, DifyClient
â”œâ”€â”€ LLMFunctionCall âš ï¸ï¼ˆç¼–è¯‘ä¾èµ–è¿‡å¤šï¼‰
â”‚   â”œâ”€â”€ FunctionCallRouter
â”‚   â””â”€â”€ æ‰€æœ‰å·¥å…·æ¨¡å—ï¼ˆ10+ï¼‰
â”œâ”€â”€ ChatSessionService
â”‚   â””â”€â”€ ChatSessionTypes
â”œâ”€â”€ LLMClientManager
â”‚   â””â”€â”€ MessageManager
â”œâ”€â”€ AppConfigRepository
â”œâ”€â”€ AIParamWidget
â””â”€â”€ GitLogReader
```

### ç†æƒ³ä¾èµ–å…³ç³»ï¼ˆæ”¹è¿›åï¼‰

```
Frm_AIAssit
â”œâ”€â”€ MainWindowPresenterï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ MessageManagerï¼ˆæ¥å£ï¼‰
â”‚   â”œâ”€â”€ LLMFunctionCallï¼ˆæ¥å£ï¼‰
â”‚   â”œâ”€â”€ ChatSessionService
â”‚   â””â”€â”€ LLMClientManager
â”œâ”€â”€ ChatInputWidget
â”œâ”€â”€ ChatShowWidget
â””â”€â”€ ChatList

MessageManagerï¼ˆæ¥å£ï¼‰
â””â”€â”€ CommonTypes.hï¼ˆå…±äº«ç±»å‹ï¼‰

LLMFunctionCallï¼ˆä½¿ç”¨æ¥å£ï¼‰
â””â”€â”€ IToolï¼ˆå·¥å…·æ¥å£ï¼‰
    â””â”€â”€ å·¥å…·å®ç°ï¼ˆå»¶è¿ŸåŠ è½½ï¼‰
```

---

## ğŸ¯ æ€»ç»“

### æ•´ä½“è¯„ä»·

**è€¦åˆåº¦**ï¼šğŸŸ¡ **ä¸­ç­‰åé«˜**

**ä¼˜ç‚¹**ï¼š
- âœ… å·¥å…·æ¨¡å—è®¾è®¡è‰¯å¥½ï¼Œç›¸äº’ç‹¬ç«‹
- âœ… ä½¿ç”¨äº†ç­–ç•¥æ¨¡å¼ï¼ˆMessageManager å­ç±»ï¼‰
- âœ… å·¥å…·è·¯ç”±ç³»ç»Ÿè®¾è®¡æ¸…æ™°

**ç¼ºç‚¹**ï¼š
- âŒ å­˜åœ¨åå‘ä¾èµ–é—®é¢˜
- âŒ å°è£…ä¸è¶³ï¼Œå¤§é‡æˆå‘˜æš´éœ²
- âŒ ä¸»çª—å£èŒè´£è¿‡é‡
- âš ï¸ ç¼–è¯‘æ—¶ä¾èµ–è¿‡å¤š

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | å·®è· |
|------|---------|---------|------|
| UI å±‚è€¦åˆåº¦ | ğŸ”´ é«˜ | ğŸŸ¢ ä½ | ğŸ”´ |
| ä¸šåŠ¡å±‚å°è£…åº¦ | ğŸŸ¡ ä¸­ | ğŸŸ¢ é«˜ | ğŸŸ¡ |
| å·¥å…·å±‚è€¦åˆåº¦ | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | âœ… |
| åå‘ä¾èµ– | âŒ å­˜åœ¨ | âœ… æ—  | ğŸ”´ |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³è¡ŒåŠ¨**ï¼ˆ1å‘¨å†…ï¼‰ï¼š
   - åˆ›å»º `CommonTypes.h` è§£å†³åå‘ä¾èµ–
   - å°è£… `MessageManager` çš„å…¬å…±æˆå‘˜
   - ä¿®å¤ `Frm_AIAssit` ç›´æ¥è®¿é—®ç§æœ‰æˆå‘˜

2. **è¿‘æœŸè¡ŒåŠ¨**ï¼ˆ1ä¸ªæœˆå†…ï¼‰ï¼š
   - å‡å°‘ `LLMFunctionCall` çš„ç¼–è¯‘æ—¶ä¾èµ–
   - è€ƒè™‘å¼•å…¥ Presenter å±‚

3. **é•¿æœŸè§„åˆ’**ï¼ˆ3-6ä¸ªæœˆï¼‰ï¼š
   - å·¥å…·æ¨¡å—æ’ä»¶åŒ–
   - å…¨é¢é‡æ„ä¸»çª—å£

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2024å¹´12æœˆ  
**åˆ†æå·¥å…·**ï¼šé™æ€ä»£ç åˆ†æ + äººå·¥å®¡æŸ¥

